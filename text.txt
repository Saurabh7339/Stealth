import React, { useEffect, useState, useCallback } from "react";
import { TextField, Autocomplete } from "@mui/material";
import { useSelector, useDispatch } from "react-redux";
import { fetchDomains } from "./domainSlice"; // Import your Redux action

const DomainSelector = () => {
  const dispatch = useDispatch();
  const domains = useSelector((state) => state.domains.list); // Getting domain list from Redux store
  const [searchTerm, setSearchTerm] = useState("");
  const [page, setPage] = useState(1);
  const [isFetching, setIsFetching] = useState(false);
  const [hasMoreAbove, setHasMoreAbove] = useState(false); // Flag for loading above
  const [hasMoreBelow, setHasMoreBelow] = useState(true);  // Flag for loading below

  // Function to fetch domains
  const loadDomains = async (search, pageNum, direction) => {
    setIsFetching(true);
    const newDomains = await dispatch(fetchDomains({ search, page: pageNum })); 

    if (direction === "above") {
      setHasMoreAbove(newDomains.length > 0); // Enable scrolling above if data exists
    } else {
      setHasMoreBelow(newDomains.length > 0); // Enable scrolling below if data exists
    }
    
    setIsFetching(false);
  };

  // Fetch initial results & handle search input
  useEffect(() => {
    const fetchInitialData = async () => {
      await loadDomains(searchTerm, 1, "below");
      setPage(2); // Reset page number after fetching first set
    };
    fetchInitialData();
  }, [searchTerm, dispatch]);

  // Load more results on scroll
  const handleScroll = useCallback(
    async (event) => {
      const listboxNode = event.currentTarget;
      const scrollTop = listboxNode.scrollTop;
      const isAtTop = scrollTop === 0;
      const isAtBottom =
        listboxNode.scrollHeight - listboxNode.scrollTop <=
        listboxNode.clientHeight + 20;

      // Load older data when scrolling up
      if (isAtTop && hasMoreAbove && !isFetching) {
        await loadDomains(searchTerm, page - 1, "above");
        setPage((prev) => (prev > 1 ? prev - 1 : prev)); // Decrease page for older records
      }

      // Load newer data when scrolling down
      if (isAtBottom && hasMoreBelow && !isFetching) {
        await loadDomains(searchTerm, page, "below");
        setPage((prev) => prev + 1);
      }
    },
    [isFetching, searchTerm, page, hasMoreAbove, hasMoreBelow, dispatch]
  );

  return (
    <Autocomplete
      freeSolo
      options={domains}
      onInputChange={(e, value) => setSearchTerm(value)}
      renderInput={(params) => (
        <TextField {...params} label="Search Domains" variant="outlined" />
      )}
      slotProps={{
        popper: {
          modifiers: [
            {
              name: "preventOverflow",
              options: { boundary: "window" },
            },
          ],
        },
        listbox: {
          onScroll: handleScroll,
          style: {
            maxHeight: "200px", // Ensure dropdown has a fixed height to enable scrolling
            overflowY: "auto",  // Enables scrolling when needed
          },
        },
      }}
      renderOption={(props, option) => (
        <li {...props} key={option.id}>
          {option.name}
        </li>
      )}
    />
  );
};

export default DomainSelector;
